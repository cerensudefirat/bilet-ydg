services:
  db:
    image: postgres:15-alpine
    container_name: bilet-db
    environment:
      POSTGRES_DB: biletdb
      POSTGRES_USER: bilet
      POSTGRES_PASSWORD: bilet
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bilet -d biletdb"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - bilet-network

  app:
    build: .
    container_name: bilet-app
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/biletdb
      SPRING_DATASOURCE_USERNAME: bilet
      SPRING_DATASOURCE_PASSWORD: bilet
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      # Testlerin beklediği admin verileri veya ayarlar için 'test' profilini aktif ediyoruz
      SPRING_PROFILES_ACTIVE: test
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    healthcheck:
      # Actuator üzerinden uygulamanın gerçekten hazır olup olmadığını kontrol eder
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 40s
    networks:
      - bilet-network

  selenium:
    image: selenium/standalone-chrome:latest
    container_name: bilet-selenium
    shm_size: 2gb
    ports:
      - "4444:4444"
      - "7900:7900"
    healthcheck:
      # Selenium'un "ready: true" vermesini bekleyerek E2E testlerinin çökmesini engelleriz
      test: ["CMD-SHELL", "curl -fsS http://localhost:4444/status | grep -q '\"ready\": true' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - bilet-network

  e2e:
    image: maven:3.9-eclipse-temurin-17
    container_name: bilet-e2e
    depends_on:
      app:
        condition: service_healthy
      selenium:
        condition: service_healthy
    working_dir: /workspace
    volumes:
      - .:/workspace
      - m2_cache:/root/.m2
    environment:
      # İç ağda app ve selenium servislerine isimleri üzerinden erişir
      E2E_BASE_URL: http://app:8080
      SELENIUM_REMOTE_URL: http://selenium:4444/wd/hub
    networks:
      - bilet-network

networks:
  bilet-network:
    driver: bridge

volumes:
  m2_cache: